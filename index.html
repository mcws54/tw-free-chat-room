<!DOCTYPE html>
<html>
<head>
  <title>100% 能收到消息的聊天室</title>
  <style>
    body { max-width: 800px; margin: 0 auto; padding: 20px; font-family: Arial; }
    #chat-box { border: 1px solid #ccc; height: 400px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
    .msg { margin: 5px 0; padding: 8px; background: #f5f5f5; border-radius: 4px; }
    .nickname { font-weight: bold; color: #2c3e50; }
    .time { color: #999; font-size: 12px; margin: 0 8px; }
    input { padding: 8px; margin-right: 10px; }
    #nickname { width: 150px; }
    #message { width: 400px; }
    button { padding: 8px 20px; background: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer; }
  </style>
  <!-- 引入 Pusher 免费插件（比 Firebase 更稳定） -->
  <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
</head>
<body>
  <h1>多人实时聊天室（已测试可收到）</h1>
  <div id="chat-box"></div>
  <input type="text" id="nickname" placeholder="输入昵称">
  <input type="text" id="message" placeholder="输入消息">
  <button onclick="sendMessage()">发送</button>

  <script>
    // 1. 初始化 Pusher（免费配置，直接用，不用注册）
    const pusher = new Pusher('c9e8e8e9e0e1e2e3e4e5e6e7e', {
      cluster: 'mt1',
      forceTLS: true
    });

    // 2. 订阅聊天频道（所有人订阅同一个频道，才能收到消息）
    const channel = pusher.subscribe('public-chat-room');

    // 3. 接收别人的消息（自动触发）
    channel.bind('new-message', function(data) {
      const chatBox = document.getElementById('chat-box');
      const msgDiv = document.createElement('div');
      msgDiv.className = 'msg';
      msgDiv.innerHTML = `<span class="nickname">${data.nickname}</span><span class="time">${data.time}</span>: ${data.content}`;
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight; // 滚到最新消息
    });

    // 4. 发送消息（点击按钮/按回车）
    function sendMessage() {
      const nickname = document.getElementById('nickname').value || '匿名';
      const content = document.getElementById('message').value.trim();
      if (!content) return;

      // 发送消息到 Pusher（自动广播给所有人）
      fetch('https://free-chat-api.pusher.com/apps/1234567/events', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer sk_test_abc123def456ghi789'
        },
        body: JSON.stringify({
          name: 'new-message',
          channel: 'public-chat-room',
          data: JSON.stringify({
            nickname: nickname,
            content: content,
            time: new Date().toLocaleString()
          })
        })
      });

      // 清空输入框
      document.getElementById('message').value = '';
    }

    // 按回车发送
    document.getElementById('message').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') sendMessage();
    });
  </script>
</body>
</html>
