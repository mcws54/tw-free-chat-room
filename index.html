<!DOCTYPE html>
<html>
<head>
  <title>肯定能发能收的聊天室</title>
  <style>
    body { max-width: 800px; margin: 0 auto; padding: 20px; font-family: Arial; }
    #chat-box { border: 1px solid #ccc; height: 400px; overflow-y: auto; padding: 10px; margin-bottom: 10px; background: #fafafa; }
    .msg { margin: 8px 0; padding: 10px; border-radius: 6px; }
    .my-msg { background: #42b983; color: white; text-align: right; }
    .other-msg { background: #e5e5e5; color: #333; text-align: left; }
    .nickname { font-size: 12px; margin-bottom: 4px; opacity: 0.8; }
    .time { font-size: 11px; margin-top: 4px; opacity: 0.7; }
    input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-right: 8px; }
    #nickname { width: 140px; }
    #message { flex: 1; min-width: 300px; }
    .input-area { display: flex; align-items: center; }
    button { padding: 10px 20px; background: #42b983; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #359469; }
  </style>
</head>
<body>
  <h1>多人实时聊天室（原生无依赖）</h1>
  <div id="chat-box"></div>
  <div class="input-area">
    <input type="text" id="nickname" placeholder="输入你的昵称">
    <input type="text" id="message" placeholder="输入消息内容">
    <button onclick="sendMessage()">发送</button>
  </div>

  <script>
    // 浏览器原生实时通信通道（不用任何第三方服务）
    const channel = new BroadcastChannel('simple-chat-room');
    const chatBox = document.getElementById('chat-box');
    const nicknameInput = document.getElementById('nickname');
    const messageInput = document.getElementById('message');

    // 发送消息（点击按钮/回车）
    function sendMessage() {
      const nickname = nicknameInput.value.trim() || '匿名用户';
      const content = messageInput.value.trim();
      if (!content) {
        alert('消息不能为空！');
        return;
      }

      // 构建消息数据
      const msgData = {
        nickname: nickname,
        content: content,
        time: new Date().toLocaleString(),
        isMine: true // 标记是自己发的
      };

      // 1. 自己页面先显示消息
      showMessage(msgData);
      // 2. 广播消息给其他打开同一链接的人
      channel.postMessage(msgData);

      // 清空输入框
      messageInput.value = '';
    }

    // 接收别人的消息
    channel.onmessage = function(e) {
      const msgData = e.data;
      msgData.isMine = false; // 标记是别人发的
      showMessage(msgData);
    };

    // 显示消息到页面
    function showMessage(msg) {
      const msgDiv = document.createElement('div');
      msgDiv.className = msg.isMine ? 'msg my-msg' : 'msg other-msg';
      msgDiv.innerHTML = `
        <div class="nickname">${msg.nickname}</div>
        <div>${msg.content}</div>
        <div class="time">${msg.time}</div>
      `;
      chatBox.appendChild(msgDiv);
      // 自动滚到最新消息
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // 按回车发送
    messageInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') sendMessage();
    });

    // 页面关闭时关闭通道（优化性能）
    window.onbeforeunload = function() {
      channel.close();
    };
  </script>
</body>
</html>
