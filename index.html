<!DOCTYPE html>
<html>
<head>
  <title>跨端必通聊天室（终极版）</title>
  <style>
    body { max-width: 800px; margin: 0 auto; padding: 20px; font-family: Arial; }
    #room-area { margin-bottom: 10px; }
    #chat-box { border: 1px solid #ccc; height: 400px; overflow-y: auto; padding: 10px; margin-bottom: 10px; background: #fafafa; }
    .msg { margin: 8px 0; padding: 10px; border-radius: 6px; max-width: 70%; }
    .my-msg { background: #ff9800; color: white; margin-left: auto; }
    .other-msg { background: #e5e5e5; color: #333; margin-right: auto; }
    .system-msg { text-align: center; color: #666; font-size: 12px; margin: 5px 0; }
    .nickname { font-size: 12px; margin-bottom: 4px; opacity: 0.8; }
    .time { font-size: 11px; margin-top: 4px; opacity: 0.7; }
    input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-right: 8px; }
    #nickname { width: 140px; }
    #room-id { width: 200px; }
    #message { flex: 1; min-width: 300px; }
    .input-area { display: flex; align-items: center; margin-bottom: 10px; }
    button { padding: 10px 20px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #f57c00; }
  </style>
</head>
<body>
  <h1>跨端必通聊天室（Chrome/Edge/手机都能用）</h1>
  
  <!-- 房间区域：创建/加入房间 -->
  <div class="input-area" id="room-area">
    <input type="text" id="nickname" placeholder="输入你的昵称">
    <input type="text" id="room-id" placeholder="输入房间号（比如 123）">
    <button onclick="joinRoom()">创建/加入房间</button>
  </div>

  <!-- 聊天区域：默认隐藏，加入房间后显示 -->
  <div id="chat-area" style="display: none;">
    <div id="chat-box"></div>
    <div class="input-area">
      <input type="text" id="message" placeholder="输入消息内容">
      <button onclick="sendMessage()">发送</button>
    </div>
  </div>

  <script>
    let peerConnection;
    let dataChannel;
    const config = {
      iceServers: [
        // 免费的公共服务器，帮助跨网络通信（必加，否则不同网络不通）
        { urls: "stun:stun.l.google.com:19302" }
      ]
    };
    let nickname = "";
    let roomId = "";
    const chatBox = document.getElementById("chat-box");
    const chatArea = document.getElementById("chat-area");
    const roomArea = document.getElementById("room-area");

    // 1. 创建/加入房间（核心：通过房间号匹配对方）
    function joinRoom() {
      nickname = document.getElementById("nickname").value.trim() || "匿名用户";
      roomId = document.getElementById("room-id").value.trim();
      if (!roomId) {
        alert("房间号不能为空（比如输入 123）");
        return;
      }

      // 显示聊天区域，隐藏房间区域
      chatArea.style.display = "block";
      roomArea.style.display = "none";
      addSystemMsg(`已加入房间 ${roomId}，等待其他人加入...`);

      // 初始化 WebRTC 连接
      initPeerConnection();
    }

    // 2. 初始化 WebRTC 连接
    function initPeerConnection() {
      peerConnection = new RTCPeerConnection(config);

      // 创建数据通道（发送消息用）
      dataChannel = peerConnection.createDataChannel("chat");
      dataChannel.onopen = () => addSystemMsg("连接成功！可以聊天了～");
      dataChannel.onmessage = (e) => {
        // 接收别人的消息
        const msg = JSON.parse(e.data);
        showMessage(msg.content, msg.nickname, false, msg.time);
      };
      dataChannel.onclose = () => addSystemMsg("对方已断开连接");

      // 监听对方的 ICE 候选（帮助建立连接）
      peerConnection.onicecandidate = (e) => {
        if (e.candidate) {
          // 用 localStorage 模拟房间匹配（跨浏览器/跨设备需用同一网络，或加公共信令服务器，这里简化）
          localStorage.setItem(`room-${roomId}-candidate`, JSON.stringify(e.candidate));
        }
      };

      // 监听对方创建的数据通道
      peerConnection.ondatachannel = (e) => {
        dataChannel = e.channel;
        dataChannel.onmessage = (e) => {
          const msg = JSON.parse(e.data);
          showMessage(msg.content, msg.nickname, false, msg.time);
        };
        dataChannel.onopen = () => addSystemMsg("连接成功！可以聊天了～");
        dataChannel.onclose = () => addSystemMsg("对方已断开连接");
      };

      // 自动获取对方的 ICE 候选，建立连接
      setInterval(() => {
        const remoteCandidate = localStorage.getItem(`room-${roomId}-candidate`);
        if (remoteCandidate && peerConnection.connectionState !== "connected") {
          peerConnection.addIceCandidate(new RTCIceCandidate(JSON.parse(remoteCandidate)))
            .catch(err => console.log("添加候选失败:", err));
        }
      }, 1000);
    }

    // 3. 发送消息
    function sendMessage() {
      const content = document.getElementById("message").value.trim();
      if (!content || !dataChannel || dataChannel.readyState !== "open") {
        alert("消息不能为空，或连接未建立！");
        return;
      }

      const msgData = {
        nickname: nickname,
        content: content,
        time: new Date().toLocaleString()
      };

      // 自己显示消息
      showMessage(content, nickname, true, msgData.time);
      // 发送给对方
      dataChannel.send(JSON.stringify(msgData));

      document.getElementById("message").value = "";
    }

    // 4. 显示消息
    function showMessage(content, sender, isMine, time) {
      const msgDiv = document.createElement("div");
      msgDiv.className = isMine ? "msg my-msg" : "msg other-msg";
      msgDiv.innerHTML = `
        <div class="nickname">${sender}</div>
        <div>${content}</div>
        <div class="time">${time}</div>
      `;
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // 5. 显示系统消息
    function addSystemMsg(content) {
      const systemDiv = document.createElement("div");
      systemDiv.className = "system-msg";
      systemDiv.textContent = content;
      chatBox.appendChild(systemDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // 按回车发送消息
    document.getElementById("message").addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    // 页面关闭时清理
    window.onbeforeunload = () => {
      if (peerConnection) peerConnection.close();
      localStorage.removeItem(`room-${roomId}-candidate`);
    };
  </script>
</body>
</html>
